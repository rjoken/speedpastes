<% pastes = local_assigns.fetch(:pastes, @pastes) %>
<% pagy_obj = local_assigns.fetch(:pagy, @pagy) %>
<% pin_context = local_assigns.fetch(:pin_context, false) %>

<turbo-frame id="pastes_list">
    <div class="divide-y divide-[var(--border-muted)]">
        <% pastes.each do |paste| %>
        <div class="px-4 py-3">
            <div class="flex items-center justify-between gap-3">
                <div class="min-w-0">
                    <%= link_to short_paste_path(paste.shortcode), class: link_class(variant: :bold), data: { turbo: false } do %>
                        <%= paste.title %>
                    <% end %>
                    <% unless @user.present? %>
                        <span class="text-xs text-[var(--muted)] mt-1"> by <%= link_to paste.user.username, profile_path(paste.user.id), class: link_class(variant: :muted, size: :xs), data: { turbo: false } %></span>
                    <% end %>

                    <div class="text-xs text-[var(--muted)] mt-1 flex items-center gap-1">
                        <%= paste.created_at.strftime("%Y-%m-%d %H:%M") %>

                        <span>|</span> 
                        <div class="text-xs text-[var(--muted)] flex gap-1" title="Total views"><%= heroicon "eye", options: {class: "w-4 h-4"} %> <%= paste.views %></div>
                        <% if current_user == @user || current_user&.admin? %>
                            <span>|</span> 
                            <%= render "shared/visibility", visibility: paste.visibility %>
                            <span>|</span> 
                            <%= link_to "Edit", edit_paste_path(paste), class: link_class(variant: :muted, size: :xs), data: { turbo: false } %> 
                            <span>|</span> 
                            <%= button_to "Delete", paste_path(paste, context: (@user.present? ? "profile" : "pastes")), method: :delete, data: { turbo_confirm: "Are you sure you want to delete this paste?", turbo_frame: "_top"}, form_class: "inline", class: link_class(variant: :muted, size: :xs) %>
                            <% if @user.present? %>
                                <span>|</span>
                                <% pin = current_user.user_pins.find_by(paste_id: paste.id) %>
                                <% if pin.present? %>
                                    <%= button_to "Unpin", user_pin_path(id: pin.id, user_id: @user.id), method: :delete, data: { turbo_method: :delete, turbo_frame: "_top" }, class: link_class(variant: :muted, size: :xs) %>
                                    <% if pin_context %>
                                        <% can_move_up = current_user.user_pins.where("position < ?", pin.position).exists? %>
                                        <% can_move_down = current_user.user_pins.where("position > ?", pin.position).exists? %>
                                        <span>|</span>
                                        <% if can_move_up %>
                                            <%= button_to "↑", user_pin_path(id: pin.id, user_id: @user.id, direction: "up"), method: :patch, data: { turbo_method: :patch, turbo_frame: "_top" }, class: link_class(variant: :muted, size: :lg) %>
                                        <% end %>
                                        <% if can_move_down %>
                                            <%= button_to "↓", user_pin_path(id: pin.id, user_id: @user.id, direction: "down"), method: :patch, data: { turbo_method: :patch, turbo_frame: "_top" }, class: link_class(variant: :muted, size: :lg) %>
                                        <% end %>
                                    <% end %>
                                <% else %>
                                    <%= button_to "Pin", user_pins_path(paste_id: paste.id, user_id: @user.id), method: :post, data: { turbo_method: :post, turbo_frame: "_top" }, class: link_class(variant: :muted, size: :xs) %>
                                <% end %>
                            <% end %>
                        <% end %>
                    </div>
                </div>
            </div>
        </div>
        <% end %>

        <% if pastes.empty? %>
            <div class="text-sm text-[var(--muted)] px-4 py-6">
                <% if params[:q].present? %>
                    No pastes found matching "<%= params[:q] %>".
                <% else %>
                    <%= @user.present? ? "This user hides many secrets!" : "No public pastes found." %>
                <% end %>
            </div>
        <% end %>
    </div>

    <% if pagy_obj.present? %>
        <div class="border-t border-[var(--border-muted)] px-4 py-3 flex justify-center">
            <%= render "shared/pagy_nav", pagy: pagy_obj %>
        </div>
    <% end %>
</turbo-frame>